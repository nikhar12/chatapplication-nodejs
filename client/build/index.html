<html>
    <head>
        <script src="https://cdn.socket.io/4.7.5/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
            integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="index.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script>
            function getRandomColor() {
                    var letters = '0123456789ABCDEF';
                    var color = '#';
                    for (var i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }
            const socket = io();
            let username;
    let color;
            $(document).ready(function(){
                let bool=false;
                $("#send").prop("disabled",true);
                 $("#message").prop("disabled", true);
                $("#btn-username-submit").click(function(){
                     username = $("#username").val();
                     if(username=="") return;
                    //$("#loading").show();
                   $("#header-text").html("Hello, "+username);
                    color = getRandomColor();
                    let data = {color:color,
                    username:username}
                    socket.emit("username-color",data);
                    $("#username-box").hide();
                    bool=true;
                    console.log(bool);
                     $("#send").prop("disabled", false);
                    $("#message").prop("disabled", false);
                });
                
                $("#send").click(function(){
                    let message = $("#message").val();
                    if(message=="") return;
                    
                    $("#message").val("");
                    let data = {
                                username:username,
                                message: message,
                            color:color}
                    socket.emit("messagefromclient",data)
                    let chatline = "<div class='chat-line'><span style='color:"+color+"'>" + username + "</span>: " + message + "</div>";
                    $("#chat-box").append(chatline);
                    var element = document.getElementById("chat-box");
                    element.scrollTop = element.scrollHeight;
                });

              $('#message').on('input', function () {
                   var targetLength = $(event.target).val().length;
                  if (targetLength % 3 == 0) {
                      let data = {
                          username: username,
                          istyping: 1
                      };
                      socket.emit("istyping", data);
                    }
                });
                $("#message").keypress(function (e) {
                   if (event.key === "Enter") {
                        event.preventDefault();
                        $("#send").click();
                    }
                   /* if (event.key >= "a" && event.key <= "z" || event.key >= "0" && event.key <= "9") {
                       var targetLength = $(event.target).val().length;
                        if(targetLength %3==0){
                        let data = {
                               username: username,
                               istyping: 1
                           };
                           socket.emit("istyping", data);
                       }
                        
                    }*/
                });
                let arrutyping=[];
                socket.on("broadcast-typing",(data)=>{
                
                     let u = arrutyping.find(p => p == data.username);
                     //console.log(u);
                    if (u === undefined) {
                        arrutyping.push(data.username);
                    }
                    
                    
                   
                        $("#typing-box").html(arrutyping + " typing....");
                         setTimeout(function timer() {
                            $("#typing-box").html("");
                            arrutyping=[];
                        }, 2500);
                    
                    
                });
                socket.on("broadcast",(data)=>{
                    let u = data.username;
                    let m = data.message;
                    let c = data.color;
                    let chatline = "<div class='chat-line'><span style='color:"+c+"'>"+u+"</span>: "+m+"</div>";
                    $("#chat-box").append(chatline);
                    var element = document.getElementById("chat-box");
                    element.scrollTop = element.scrollHeight;
                    if(m=="[incomingmessage]"){
                        new Audio('/audio/incoming-message.mp3').play()
                    }else if (m == "[messageforme]") {
                        new Audio('/audio/message-for-me.mp3').play()
                    }
                    else if(m=="[virus]"){
                      
                        $("#virus").show();
                        /*    for (let i = 20; i <=100; i++) {
                            setTimeout(function timer() {
                                $("#virus-loading-text").html(i); 
                            }, 3000);
                        }*/
                    }
                });
                socket.on("user-joined",(data)=>{
                    let chatline = "<div class='chat-line-server'>server: " + data.username+ " joined chat group.</div>";
                    $("#chat-box").append(chatline);
                })

                socket.on("userlist",(data)=>{
                    let li="";
                    $("#group-users-list ul").html("");
                    for(let i=0;i<data.length;i++){
                         li = li+"<li style='color:"+data[i].color+"'>"+data[i].username+"</li>";
                    }
                    
                    $("#group-users-list ul").append(li);
                })
         
            });
        </script>
    </head>
    <body>
        <h3 id="header-text">Hello, user</h3>
        <div id="parentdiv">
        <div id="chat-window" class="childs">
<div id="chat-box" >

</div>
<div id="typing-box"></div>
<div id="send-box" >
    <input type="text" id="message" autocomplete="off"/>
    <input type="submit" id="send" value="send"/>

</div>
</div>
<div id="group-users-list" class="childs">
    <span>People Online</span>
<ul>
    
</ul>
</div>
</div>
<div id="username-box">
    <input type="text" placeholder="enter name" id="username" autocomplete="off"/>
    <button type="button" id="btn-username-submit">Submit</button>

    <div id="loading">loading...</div>
</div>

<div id="virus">
    <div id="virus-text-center">
        <h2>VIRUS WARNING!!</h2>
        <h2>You have been hacked!!!</h2>
        <h3>uploading your data to server...</h3>
        <h4 id="virus-loading-text"></h4>
    </div>
</div>
    </body>
</html>